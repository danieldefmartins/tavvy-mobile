// ============================================
// UPDATED fetchPlaces function for fsq_places_raw table
// Replace lines 503-612 in HomeScreen.tsx with this:
// ============================================

const fetchPlaces = async (location?: [number, number]) => {
  try {
    setLoading(true);

    // Use provided location, userLocation, or default to Austin, TX
    const centerLng = location?.[0] || userLocation?.[0] || -97.7431;
    const centerLat = location?.[1] || userLocation?.[1] || 30.2672;
    
    // Create a bounding box (~10km radius) for fast indexed query
    const latDelta = 0.1;  // ~11km
    const lngDelta = 0.1;  // ~9km at this latitude
    
    const minLat = centerLat - latDelta;
    const maxLat = centerLat + latDelta;
    const minLng = centerLng - lngDelta;
    const maxLng = centerLng + lngDelta;

    console.log(`Fetching places near [${centerLng}, ${centerLat}]`);

    // Query fsq_places_raw table (Foursquare data with 104M places)
    const { data: placesData, error: placesError } = await supabase
      .from('fsq_places_raw')
      .select('fsq_place_id, name, latitude, longitude, address, locality, region, country, fsq_category_ids, fsq_category_labels, tel, website, email, instagram, twitter, facebook_id')
      .gte('latitude', minLat)
      .lte('latitude', maxLat)
      .gte('longitude', minLng)
      .lte('longitude', maxLng)
      .limit(200);  // Limit results for performance

    if (placesError) {
      console.warn('Supabase error:', placesError);
      setPlaces(MOCK_PLACES);
      setFilteredPlaces(MOCK_PLACES);
      return;
    }

    console.log('Fetched places from Supabase:', placesData?.length || 0);

    if (placesData && placesData.length > 0) {
      // Process places - map fsq_places_raw columns to app's Place interface
      const processedPlaces = placesData
        .filter((place) => {
          return typeof place.longitude === 'number' && typeof place.latitude === 'number' && 
                 !isNaN(place.longitude) && !isNaN(place.latitude) && 
                 place.longitude !== 0 && place.latitude !== 0;
        })
        .map(place => {
          // Parse category from fsq_category_labels (stored as comma-separated string)
          let category = 'Other';
          if (place.fsq_category_labels) {
            // fsq_category_labels might be a string like "Restaurant,Food" or already an array
            const labels = typeof place.fsq_category_labels === 'string' 
              ? place.fsq_category_labels.split(',') 
              : place.fsq_category_labels;
            if (labels && labels.length > 0) {
              category = labels[0].trim();
            }
          }

          return {
            id: place.fsq_place_id,
            name: place.name,
            latitude: place.latitude,
            longitude: place.longitude,
            address_line1: place.address || '',
            city: place.locality || '',
            state_region: place.region || '',
            country: place.country || '',
            category: category,
            primary_category: category,
            fsq_category_labels: place.fsq_category_labels,
            phone: place.tel || '',
            website: place.website || '',
            email: place.email || '',
            instagram_url: place.instagram || '',
            facebook_url: place.facebook_id || '',
            twitter: place.twitter || '',
            // No signals or photos for Foursquare data
            signals: [],
            photos: [],
            cover_image_url: null,
            description: '',
            current_status: 'Unknown',
          };
        });

      console.log('Processed places with valid coords:', processedPlaces.length);
      setPlaces(processedPlaces);
      setFilteredPlaces(processedPlaces);
    } else {
      console.log('No places found in database');
      setPlaces(MOCK_PLACES);
      setFilteredPlaces(MOCK_PLACES);
    }
  } catch (err) {
    console.error('Error fetching places:', err);
    setPlaces(MOCK_PLACES);
    setFilteredPlaces(MOCK_PLACES);
  } finally {
    setLoading(false);
  }
};
